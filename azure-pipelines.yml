# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - dev   # Trigger pipeline on any push to dev branch

pool:
  name: Self-hosted

steps:
  # 1️⃣ Checkout dev branch with credentials
  - checkout: self
    persistCredentials: true

  # 2️⃣ Fetch latest changes and sync dev branch
  - task: Bash@3
    displayName: Sync dev branch with remote
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        echo "===================================="
        echo "Fetching all branches from origin..."
        git fetch origin
        echo "Done fetching."
        echo "===================================="

        echo "Checking out dev branch..."
        git checkout dev
        echo "Done."
        echo "===================================="

        echo "Pulling latest changes from remote dev (rebase)..."
        git pull origin dev --rebase
        echo "Dev branch is now up-to-date."
        echo "===================================="

  # 3️⃣ Optional: Run any tests or quality checks (placeholder)
  - task: Bash@3
    displayName: Run optional checks
    inputs:
      targetType: inline
      script: |
        echo "Running optional tests or code quality checks..."
        # Example: pytest, dotnet test, SonarQube scan, etc.
        echo "Checks complete."
        echo "===================================="

  # 4️⃣ Create Pull Request from dev -> master
  - task: Bash@3
    displayName: Create Pull Request dev -> master
    inputs:
      targetType: inline
      script: |
        echo "Creating Pull Request from dev to master..."
        az repos pr create --repository AWS_EC2 \
                           --source-branch dev \
                           --target-branch master \
                           --title "Auto PR: dev → master" \
                           --description "Automated PR generated by pipeline"
        echo "Pull Request created successfully."
        echo "===================================="
